# .github\workflows\ci_cd.yaml

name: CiCd pipeline

on: 
    push:
        branches:
            - main

jobs:
    mlops-pipeline:
        runs-on: ubuntu-latest


        steps:
            - name: checkout code
              uses: actions/checkout@v3

            - name: setup python
              uses: actions/setup-python@v2
              with:
                python-version: '3.10'

            - name: Cache pip dependencies
              uses: actions/cache@v3
              with:
                path: ~/.cache/pip
                key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
                restore-keys: |
                  ${{ runner.os }}-pip-
            
            - name: upgrade pip and wheel
              run: |
                python -m pip install --upgrade pip wheel

            - name: ensure setuptools is installed
              run: |
                python -m pip install --upgrade setuptools || true

            - name: check pkg_resources and setuptools (diagnostic)
              run: |
                python - <<'PY'
                try:
                    import pkg_resources
                    print('pkg_resources ok:', getattr(pkg_resources, '__file__', 'unknown'))
                except Exception as e:
                    print('pkg_resources missing:', e)
                try:
                    import setuptools
                    print('setuptools ok:', setuptools.__version__)
                except Exception as e:
                    print('setuptools missing:', e)
                PY

            - name: install dependencies
              run: python -m pip install -r requirements.txt

            - name: reinstall setuptools to ensure pkg_resources is available
              run: |
                python -m pip install --force-reinstall --no-deps setuptools>=65.0.0

            - name: run pipeline
              env:
                CAPSTONE_TEST: ${{secrets.CAPSTONE_TEST}}
              run: dvc repro

            
